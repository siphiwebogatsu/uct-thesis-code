---
title: "IRM Processing 3"
author: "Siphiwe Bogatsu"
date: "2025-10-04"
Purpose: "Keep a single project-level row and pivot all budget/expenditure fields
          wide  by IRM financial year, preserving stage-by-stage detail per FY"
output: html_document
---


#----------------- Reproduce --------------------------------------------------
```{r}
install.packages("renv")
renv::restore()
```


#- --------- ----- Load the data ----------------------------------------------

```{r}
all_irm_years = read_dta("zaf-nt-irm-v1.2.dta")
```

#--------------- Columns we will pivot ----------------------------------------
```{r}
exp_cols <- c(
"budg_main_cstr", "budg_adj_cstr", "budg_main_pf", "budg_adj_pf",
"prjtd_exp_q1", "prjtd_exp_q2", "prjtd_exp_q3", "prjtd_exp_q4",
"exp_q1", "exp_q2", "exp_q3", "exp_q4"
)


# Make sure the columns exist (some IRM years may not have all of them)
exp_cols <- intersect(exp_cols, names(all_irm_years))


# Ensure they are numeric (in case prior steps introduced strings)
all_irm_years <- all_irm_years |>
mutate(across(all_of(exp_cols), ~ suppressWarnings(readr::parse_number(as.character(.x)))))
```


#----------------- Build a clean long - > wide expenditure table --------------

```{r}
exp_long <- all_irm_years |>
select(proj_id, irm_year, all_of(exp_cols)) |>
distinct() # guard against duplicates per proj_id, irm_year


exp_wide <- exp_long |>
pivot_wider(
id_cols = proj_id,
names_from = irm_year,
values_from = all_of(exp_cols),
names_sep = "__" # e.g., exp_q1__15_16
)

# Keep latest available non-expenditure attributes for each project.
non_exp_cols <- setdiff(names(all_irm_years), exp_cols)
base_latest <- all_irm_years |>
select(all_of(non_exp_cols)) |>
arrange(proj_id, irm_year) |>
group_by(proj_id) |>
slice_tail(n = 1) |>
ungroup()

# Join back the wide expenditure block
all_irm_years_wide <- base_latest |>
left_join(exp_wide, by = "proj_id")

```





# --------------------- Write ------------------------------------------------

```{r}
write_dta(all_irm_years, "zaf-nt-irm-v1.3.dta")
```

